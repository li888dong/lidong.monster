(function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["index"]=e():t["index"]=e()})("undefined"!==typeof self?self:this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s="bc95")}({b2ad:function(t,e,n){var i,o,r;(function(n,s){o=[],i=s,r="function"===typeof i?i.apply(e,o):i,void 0===r||(t.exports=r)})("undefined"!==typeof self&&self,(function(){function t(){if(document.currentScript)return document.currentScript;try{throw new Error}catch(h){var t,e,n,i=/.*at [^(]*\((.*):(.+):(.+)\)$/gi,o=/@([^@]*):(\d+):(\d+)\s*$/gi,r=i.exec(h.stack)||o.exec(h.stack),s=r&&r[1]||!1,a=r&&r[2]||!1,c=document.location.href.replace(document.location.hash,""),u=document.getElementsByTagName("script");s===c&&(t=document.documentElement.outerHTML,e=new RegExp("(?:[^\\n]+?\\n){0,"+(a-2)+"}[^<]*<script>([\\d\\D]*?)<\\/script>[\\d\\D]*","i"),n=t.replace(e,"$1").trim());for(var l=0;l<u.length;l++){if("interactive"===u[l].readyState)return u[l];if(u[l].src===s)return u[l];if(s===c&&u[l].innerHTML&&u[l].innerHTML.trim()===n)return u[l]}return null}}return t}))},bc95:function(t,e,n){"use strict";if(n.r(e),n.d(e,"webvoice",(function(){return y})),"undefined"!==typeof window){var i=window.document.currentScript,o=n("b2ad");i=o(),"currentScript"in document||Object.defineProperty(document,"currentScript",{get:o});var r=i&&i.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);r&&(n.p=r[1])}class s{constructor(){this._constraints={audio:!0,video:!1};let t=function(t){let e=navigator.getUserMedia||navigator.webketGetUserMedia||navigator.mozGetUserMedia;return e?new Promise((function(n,i){e.call(navigator,t,n,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=t)}promiseStream(){let t=new Promise((t,e)=>{navigator.mediaDevices.getUserMedia(this._constraints).then(e=>{t(e)}).catch(t=>{e(t)})});return t}}class a{constructor(t){this._context=null,this._config=t;try{window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,this._context=new AudioContext}catch(e){console.log(e)}}isSupport(){return!(null===this._context)}}class c extends a{constructor(t,e){super(t),this._lsize=0,this._rsize=0,this._LBuffer=[],this._RBuffer=[],this._recording=!1,this._scriptProcessorNode=this._context.createScriptProcessor(this._config.bufferSize,this._config.numberChannels,this._config.numberChannels),this._mediaStreamAudioSourceNode=this._context.createMediaStreamSource(e),this._mediaStreamAudioSourceNode.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._context.destination);let n=this;this._scriptProcessorNode.onaudioprocess=function(e){if(!n._recording)return;let i=e.inputBuffer;for(let t=0;t<i.numberOfChannels;t++){let e=i.getChannelData(t);0===t?(n._LBuffer.push(new Float32Array(e)),n._lsize+=e.length):1===t&&(n._RBuffer.push(new Float32Array(e)),n._rsize+=e.length)}t.player.send()}}clear(){this._LBuffer.length=0,this._RBuffer.length=0,this._lsize=0,this._lsize=0}start(){this._recording=!0}get(){this._context.sampleRate,this._config.outputSampleRate;let t=function(t,e){let n=new Float32Array(e),i=0;for(let o=0;o<t.length;o++)n.set(t[o],i),i+=t[o].length;return n},e=function(t,e){let n=t.length+e.length,i=new Float32Array(n),o=0,r=0;while(o<n)i[o++]=t[r],i[o++]=e[r],r++;return i},n=null;if(1===this._config.numberChannels)n=t(this._LBuffer,this._lsize);else if(2===this._config.numberChannels){let i=t(this._LBuffer,this._lsize),o=t(this._RBuffer,this._rsize);n=e(i,o)}return console.log("data格式"+n),n}stop(){this._recording=!1}}class u extends a{constructor(t){super(t)}start(){let t=this._context.createGain();this._audioBufferSourceNode=this._context.createBufferSource(),this._audioBufferSourceNode.connect(t),t.connect(this._context.destination),this._audioBufferSourceNode.start()}pushAudioData(t){this._context.decodeAudioData(t).then(t=>{this._audioBufferSourceNode.buffer=t}).catch(t=>{throw t})}pushDataArray(t){let e=this._context.createBuffer(this._config.numberChannels,5*this._context.sampleRate,this._context.sampleRate);for(let n=0;n<this._config.numberChannels.length;n++){let t=e.getChannelData(n);for(let e=0;e<array.length;e++)t[e]=array[e]}this._audioBufferSourceNode.buffer=e}}const l={url:"",bufferSize:2048,numberChannels:1,inputSampleBits:16,outputSampleRate:16e3/6,outputSampleBits:16};class h{constructor(){}static wav(t,e,n,i){let o=t.length*(n/8),r=new ArrayBuffer(44+o),s=new DataView(r),a=i,c=0,u=function(t){for(let e=0;e<t.length;e++)s.setUint8(c+e,t.charCodeAt(e))};if(u("RIFF"),c+=4,s.setUint32(c,36+o,!0),c+=4,u("WAVE"),c+=4,u("fmt "),c+=4,s.setUint32(c,16,!0),c+=4,s.setUint16(c,1,!0),c+=2,s.setUint16(c,a,!0),c+=2,s.setUint32(c,e,!0),c+=4,s.setUint32(c,a*e*(n/8),!0),c+=4,s.setUint16(c,a*(n/8),!0),c+=2,s.setUint16(c,n,!0),c+=2,u("data"),c+=4,s.setUint32(c,o,!0),c+=4,8===n)for(let l=0;l<t.length;l++,c++){let e=Math.max(-1,Math.min(1,t[l])),n=e<0?32768*e:32767*e;n=parseInt(255/(65535/(n+32768))),s.setInt8(c,n,!0)}else for(let l=0;l<t.length;l++,c+=2){let e=Math.max(-1,Math.min(1,t[l]));s.setInt16(c,e<0?32768*e:32767*e,!0)}return s}}class f{constructor(t){this._isConnected=!1,this._websocket=new WebSocket(t),this._websocket.binaryType="arraybuffer",this._receivedEvent=null,this._errorEvent=null;let e=this;this._websocket.onopen=function(t){e._isConnected=!0},this._websocket.onmessage=function(t){e._receivedEvent&&e._receivedEvent(t.data)},this._websocket.onerror=function(t){e._errorEvent&&e._errorEvent(t)}}send(t){return!!this._isConnected&&(this._websocket.send(t),!0)}close(){return 0===this._websocket.bufferedAmount&&(this._websocket.close(),!0)}on(t,e){switch(t){case"received":this._receivedEvent="function"===typeof e?e:null;case"error":this._errorEvent="function"===typeof e?e:null;default:break}}}class d{constructor(){}static wav(t){return new Blob([t],{type:"audio/wav"})}}class p{constructor(t){this.as3ele=null;let e={outSampleRate:t.outputSampleRate,numberChannels:t.numberChannels},n={menu:"false",scale:"noScale",allowFullscreen:"true",allowScriptAccess:"always",bgcolor:"",wmode:"direct"},i={id:"audioas3"},o=t.swfPath?t.swfPath:"./audio.swf",r=t.domid;if(!r)throw new Error("audio.swf need a dom element");if(!swfobject)throw new Error("the swfobject is need");{let t=document.getElementById(r),s=this;swfobject.embedSWF(o,r,t.clientWidth,t.clientHeight,"25.0.0","./expressInstall.swf",e,n,i,(function(){s.as3ele=document.getElementById(i.id)}))}}ready(){this.as3ele.ready()}start(){this.as3ele.start()}stop(){this.as3ele.stop()}clear(){this.as3ele.clear()}get(){return this.as3ele.getbuffer()}}class _{constructor(){let t=document.createElement("bgsound");t.setAttribute("loop","false"),t.setAttribute("audostart","true"),t.setAttribute("style","display:none;"),t.id="audioas3_"+(new Date).getTime();let e=document.querySelector("body");e.appendChild(t),this._audio=document.getElementById(t.id)}play(t){this._audio.src=window.URL.createObjectURL(t)}}class m{constructor(){}static deepAssign(t){var e=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=function(t){var e=typeof t;return null!==t&&("object"===e||"function"===e)},o=function(t){if(null===t||void 0===t)throw new TypeError("Cannot convert undefined or null to object");return Object(t)},r=function(t,n,o){var r=n[o];if(void 0!==r&&null!==r){if(e.call(t,o)&&(void 0===t[o]||null===t[o]))throw new TypeError("Cannot convert undefined or null to object ("+o+")");e.call(t,o)&&i(r)?t[o]=s(Object(t[o]),n[o]):t[o]=r}},s=function(t,i){if(t===i)return t;for(var o in i=Object(i),i)e.call(i,o)&&r(t,i,o);if(Object.getOwnPropertySymbols)for(var s=Object.getOwnPropertySymbols(i),a=0;a<s.length;a++)n.call(i,s[a])&&r(t,i,s[a]);return t};t=o(t);for(var a=1;a<arguments.length;a++)s(t,arguments[a]);return t}}function g(t){this.init(t)}g.prototype.init=function(t){var e={encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:1e3};this.option=Object.assign({},e,t),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},g.prototype.getMaxValue=function(){var t={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},g.prototype.getTypedArray=function(){var t={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},g.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},g.prototype.isTypedArray=function(t){return t.byteLength&&t.buffer&&t.buffer.constructor==ArrayBuffer},g.prototype.feed=function(t){if(this.isTypedArray(t)){t=this.getFormatedValue(t);var e=new Float32Array(this.samples.length+t.length);e.set(this.samples,0),e.set(t,this.samples.length),this.samples=e}},g.prototype.getFormatedValue=function(t){t=new this.typedArray(t.buffer);var e,n=new Float32Array(t.length);for(e=0;e<t.length;e++)n[e]=t[e]/this.maxValue;return n},g.prototype.volume=function(t){this.gainNode.gain.value=t},g.prototype.destroy=function(){this.interval&&clearInterval(this.interval),this.samples=null,this.audioCtx.close(),this.audioCtx=null},g.prototype.flush=function(){if(this.samples.length){var t,e,n,i,o,r=this.audioCtx.createBufferSource(),s=this.samples.length/this.option.channels,a=this.audioCtx.createBuffer(this.option.channels,s,this.option.sampleRate);for(e=0;e<this.option.channels;e++)for(t=a.getChannelData(e),n=e,o=50,i=0;i<s;i++)t[i]=this.samples[n],i<50&&(t[i]=t[i]*i/50),i>=s-51&&(t[i]=t[i]*o--/50),n+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),console.log("start vs current "+this.startTime+" vs "+this.audioCtx.currentTime+" duration: "+a.duration),r.buffer=a,r.connect(this.gainNode),r.start(this.startTime),this.startTime+=a.duration,this.samples=new Float32Array}};var w=g;class b{constructor(t){this._config={player:this},m.deepAssign(this._config,l,t||l);let e=this,n=new u(e._config);new _;this._incontext=null,this._as3context=null,n.isSupport()||(this._as3context=new p(e._config)),this._ws=new f(this._config.url);var i=new w({encoding:"16bitInt",channels:1,sampleRate:16e3,flushingTime:2e3});this._ws.on("received",(function(t){var e=new Uint8Array(t);i.feed(e)}))}ready(){let t=this,e=new s;window.Promise?e.promiseStream().then(e=>{t._incontext=new c(t._config,e)}).catch(e=>{t._as3context.ready()}):t._as3context.ready()}speak(){this._incontext?this._incontext.start():this._as3context&&this._as3context.start()}send(){if(this._incontext){let t=this._incontext.get(),e=h.wav(t,this._config.outputSampleRate,this._config.outputSampleBits,this._config.numberChannels),n=e.buffer;this._ws.send(n.slice(44,n.length)),this._incontext.clear()}else if(this._as3context){let t=this._as3context.get();this._ws.send(t),this._as3context.stop(),this._as3context.clear()}}close(){this._incontext?(this._incontext.stop(),console.log("已关闭通话")):this._as3context&&this._as3context.stop()}getbuffer(t){if(this._incontext&&"function"===typeof t){let e=this._incontext.get();this._incontext.stop(),this._incontext.clear(),t(e)}else if(this._as3context){let e=this._as3context.get();this._as3context.stop(),this._as3context.clear(),t(e)}}exportwav(t){if(this._incontext&&"function"===typeof t){let e=this._incontext.get(),n=h.wav(e,this._config.outputSampleRate,this._config.outputSampleBits,this._config.numberChannels),i=d.wav(n);this._incontext.stop(),this._incontext.clear(),t(i)}else if(this._as3context){let e=this._as3context.get(),n=h.wav(e,this._config.outputSampleRate,this._config.outputSampleBits,this._config.numberChannels),i=d.wav(n.buffer);this._as3context.stop(),this._as3context.clear(),t(i)}}forcedownload(t){this.exportwav((function(e){let n=(window.URL||window.webkitURL).createObjectURL(e),i=window.document.createElement("a");i.href=n,i.download=t||(new Date).toISOString()+".wav";let o=document.createEvent("Event");o.initEvent("click",!0,!0),i.dispatchEvent(o)}))}}let y={};new s;y.createPlayer=function(t){return new b(t)},Object.defineProperty(y,"version",{enumerable:!0,get:function(){return"0.0.2"}})}})}));
//# sourceMappingURL=index.umd.min.js.map